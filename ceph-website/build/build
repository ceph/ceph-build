#!/bin/bash
set -ex

## TODO: Check if only the src/ dir changed and `exit 0` if only the ceph.io.git README or something else inconsequential changed.
env

BRANCH=$(echo $GIT_BRANCH | sed 's:.*/::')

npm install

if [ "$BRANCH" == "main" ]; then
  npm run build:production
else
  npm run build:development
fi

if [ ! -d /opt/www/${BRANCH} ]; then
  mkdir -p /opt/www/${BRANCH}
fi

rsync -av --delete-after dist/ /opt/www/${BRANCH}/

# This just makes the last `echo` line not repeat
{ set +x; } 2>/dev/null

echo "Success!  This site is available at https://${BRANCH}.ceph.io."

# Prune old built branches from /opt/www/
# echo "main $BRANCH" to make absolutely sure we don't wipe out the live site or the $BRANCH we just built in case `git branch` comes back empty somehow.
CURRENT_BRANCHES=$(echo "main $BRANCH" && git branch -r | sed 's:.*/::')
for DIR in $(find /opt/www/ -maxdepth 1 -type d -print | sed 's:.*/::'); do
  if ! echo $CURRENT_BRANCHES | grep -q $DIR; then
    rm -rf /opt/www/$DIR
  fi
done
