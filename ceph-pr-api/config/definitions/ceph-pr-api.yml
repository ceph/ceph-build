# ======================================================================
# Jenkins Job Builder (JJB) definition for Ceph API tests
# This job builds Ceph PRs, installs API test deps, runs API tests,
# and reports status back to GitHub.
# ======================================================================

- job:
    name: ceph-api                       # Unique Jenkins job name
    project-type: freestyle              # Job type (freestyle pipeline)
    defaults: global                     # Inherit global defaults
    concurrent: true                     # Allow concurrent builds
    node: huge && bionic && x86_64 && !smithi  # Node label (restricts where job runs)
    display-name: 'ceph: API'            # Human-readable display name in Jenkins
    quiet-period: 5                      # Wait (seconds) before starting after trigger
    block-downstream: false              # Do not block downstream jobs
    block-upstream: false                # Do not block upstream jobs
    retry-count: 3                       # Retry job up to 3 times on failure

    # ------------------------------------------------------------------
    # Job properties: build retention, GitHub link, rebuild options, env vars
    # ------------------------------------------------------------------
    properties:
      - build-discarder:                 # Manage build history cleanup
          days-to-keep: 15
          num-to-keep: 300
          artifact-days-to-keep: -1
          artifact-num-to-keep: -1
      - github:                          # Link job to GitHub repo
          url: https://github.com/ceph/ceph/
      - rebuild:                         # Allow auto-rebuild
          auto-rebuild: true
      - inject:                          # Inject environment variables
          properties-content: |
            TERM=xterm

    # ------------------------------------------------------------------
    # Job parameters: passed into the build
    # ------------------------------------------------------------------
    parameters:
      - string:
          name: sha1                     # Commit SHA or refname to build
          description: "commit id or a refname, like 'origin/pr/72/head'"

    # ------------------------------------------------------------------
    # Job triggers: GitHub PR events + trigger phrase
    # ------------------------------------------------------------------
    triggers:
      - github-pull-request:             # Trigger on GitHub PR activity
          cancel-builds-on-update: true  # Cancel running build if PR is updated
          allow-whitelist-orgs-as-admins: true
          org-list:
            - ceph                       # Allow PRs from Ceph org
          white-list-target-branches:    # Only trigger for these branches
            - main
            - tentacle
            - squid
            - reef
            - "feature-.*"
          trigger-phrase: 'jenkins test api'     # Manual trigger phrase in PR comments
          skip-build-phrase: '^jenkins do not test.*'
          only-trigger-phrase: false
          github-hooks: true             # Enable webhook triggers
          permit-all: true               # Allow all PR authors
          auto-close-on-fail: false      # Do not auto-close PRs on failure
          status-context: "ceph API tests"         # GitHub PR status checks
          started-status: "running API tests"
          success-status: "ceph API tests succeeded"
          failure-status: "ceph API tests failed"

    # ------------------------------------------------------------------
    # Source Code Management (SCM): checkout PR code
    # ------------------------------------------------------------------
    scm:
      - git:
          url: https://github.com/ceph/ceph.git
          branches:
            - origin/pr/${{ghprbPullId}}/merge    # Build PR merge branch
          refspec: +refs/pull/${{ghprbPullId}}/*:refs/remotes/origin/pr/${{ghprbPullId}}/*
          browser: auto
          timeout: 20
          skip-tag: true
          shallow-clone: true
          wipe-workspace: true           # Clean workspace before build

    # ------------------------------------------------------------------
    # Build steps: compile code, install API test deps, run API tests
    # ------------------------------------------------------------------
    builders:
      - shell:
          !include-raw-verbatim:
            - ../../../scripts/build_utils.sh
            - ../../build/build
            - ../../../scripts/dashboard/install-backend-api-test-deps.sh
            - ../../build/api

    # ------------------------------------------------------------------
    # Post-build actions: cleanup, log archiving
    # ------------------------------------------------------------------
    publishers:
      - postbuildscript:                 # Run cleanup on aborted builds
          builders:
            - role: SLAVE
              build-on:
                  - ABORTED
              build-steps:
                - shell: "sudo dpkg --configure -a"   # Fix broken dpkg if apt was interrupted
      - archive:                         # Archive logs for debugging
          artifacts: 'build/out/*.log'
          allow-empty: true
          latest-only: false

    # ------------------------------------------------------------------
    # Wrappers: console color + credential injection
    # ------------------------------------------------------------------
    wrappers:
      - ansicolor                        # Enable ANSI color in console logs
      - credentials-binding:             # Inject GitHub credentials
          - username-password-separated:
              credential-id: github-readonly-token
              username: GITHUB_USER
              password: GITHUB_PASS
