def allDists = ['centos9', 'centos10', 'rocky9', 'rocky10', 'focal', 'jammy', 'noble', 'bookworm'];
def allArches = ['x86_64', 'arm64'];
def allFlavors = ['default', 'crimson-release', 'crimson-debug'];
def crimsonFlavors = ['crimson-release', 'crimson-debug'];
def containerDists = ['centos9', 'rocky10'];
def base_node_label = "gigantic"
def parallelBuilds = [:];

pipeline {
  agent any
  stages {
    stage("source distribution") {
      steps {
        script {
          def buildImpl = load 'ceph-dev-pipeline/build/build.groovy';
          result = buildImpl.build_source_dist([
            SETUP_JOB: env.SETUP_JOB,
            SETUP_BUILD_ID: env.SETUP_BUILD_ID,
            CEPH_REPO: env.CEPH_REPO,
            BRANCH: env.BRANCH,
            SHA1: env.SHA1,
            CEPH_BUILD_BRANCH: env.CEPH_BUILD_BRANCH,
            RELEASE_TYPE: env.RELEASE_TYPE,
            RELEASE_BUILD: env.RELEASE_BUILD,
            VERSION: env.VERSION,
          ]);
          env.putAll(result);
        }
      }
    }
    stage("parallel build") {
      steps {
        script {
          def buildImpl = load 'ceph-dev-pipeline/build/build.groovy';
          requestedDists = env.DISTROS.split(' ');
          requestedArchs = env.ARCHS.split(' ');
          requestedFlavors = env.FLAVORS.split(' ');
          for (DIST in allDists) {
            if ( ! requestedDists.contains(DIST) ) continue;
            for (ARCH in allArches) {
              if ( ! requestedArchs.contains(ARCH) ) continue;
              for (FLAVOR in allFlavors) {
                if ( ! requestedFlavors.contains(FLAVOR) ) continue;
                if ( crimsonFlavors.contains(FLAVOR) &&  (DIST != 'centos9' || ARCH != 'x86_64') ) continue;
                if ( env.CI_COMPILE == true || (env.CI_CONTAINER == "true" && containerDists.contains(DIST)) ) { 
                  parallelBuilds["${DIST} ${ARCH} ${FLAVOR}"] = {
                    node { label "(installed-os-centos9||installed-os-noble)&&${ARCH}&&${base_node_label}" }
                    buildImpl.do_build([
                      env: env,
                    ]);
                  }
                }
              }
            }
          }
          parallel parallelBuilds;
        }
      }
    }
  }
}
