def allDists = ['centos9', 'centos10', 'rocky9', 'rocky10', 'focal', 'jammy', 'noble', 'bookworm']
def allArches = ['x86_64', 'arm64']
def allFlavors = ['default', 'crimson-release', 'crimson-debug']
def crimsonFlavors = ['crimson-release', 'crimson-debug']
def containerDists = ['centos9', 'rocky10']
def base_node_label = "gigantic"
def parallelBuilds = [:]

def buildImpl;

pipeline {
  agent any
  stages {
    stage("source distribution") {
      steps {
        script {
          if ( ! env.SETUP_BUILD_ID ) {
            def setup_build = build(
              job: env.SETUP_JOB,
              parameters: [
                string(name: "BRANCH", value: env.BRANCH),
                // Below are just for ceph-source-dist
                string(name: "SHA1", value: env.SHA1),
                string(name: "CEPH_REPO", value: env.CEPH_REPO),
                string(name: "CEPH_BUILD_BRANCH", value: env.CEPH_BUILD_BRANCH),
                // Below are only for actual releases
                string(name: 'RELEASE_TYPE',  value: env.RELEASE_TYPE ?: ''),
                string(name: 'RELEASE_BUILD', value: env.RELEASE_BUILD ?: ''),
                string(name: 'VERSION',       value: env.VERSION ?: '')
              ]
            )
            env.SETUP_BUILD_ID = setup_build.getNumber()
          }
          println "SETUP_BUILD_ID=${env.SETUP_BUILD_ID}"
          env.SETUP_BUILD_URL = new URI([env.JENKINS_URL, "job", env.SETUP_JOB, env.SETUP_BUILD_ID].join("/")).normalize()
          println "${env.SETUP_BUILD_URL}"

        }
      }
    }
    stage("parallel build") {
      steps {
        script {
          requestedDists = env.DISTROS.split(' ');
          requestedArchs = env.ARCHS.split(' ');
          requestedFlavors = env.FLAVORS.split(' ');
          for (DIST in allDists) {
            if ( ! requestedDists.contains(DIST) ) continue;
            for (ARCH in allArches) {
              if ( ! requestedArchs.contains(ARCH) ) continue;
              for (FLAVOR in allFlavors) {
                if ( ! requestedFlavors.contains(FLAVOR) ) continue;
                if ( crimsonFlavors.contains(FLAVOR) &&  (DIST != 'centos9' || ARCH != 'x86_64') ) continue;
                if ( env.CI_COMPILE == true || (env.CI_CONTAINER == "true" && containerDists.contains(DIST)) ) { 
                  parallelBuilds["${DIST} ${ARCH} ${FLAVOR}"] = {
                    node {
                      label "(installed-os-centos9||installed-os-noble)&&${ARCH}&&${base_node_label}"
                      buildImpl = load 'ceph-dev-pipeline/build/build.groovy'
                      buildImpl.do_build([
                        env: env,
                      ]);
                    }
                  }
                }
              }
            }
          }
          parallel parallelBuilds;
        }
      }
    }
  }
}
