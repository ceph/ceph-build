#!/bin/bash
# vim: ts=4 sw=4 expandtab
set -ex

# create a release directory for ceph-build tools
mkdir -p release
cp -a dist release/${vers}

echo "Building RPMs"

# The below contents ported from /srv/ceph-build/build_rpms.sh ::
#     $bindir/build_rpms.sh ./release $vers
#

releasedir="./release"
cephver=$vers

cd $releasedir/$cephver || exit 1

# This is needed because the 'version' this job gets from upstream contains chars
# that are not legal for an RPM file. These are already converted in the spec file whic
# is what is consumed to create the RPM binary. Parse these values there so that they can
# be reported as part of the build metadata
RPM_RELEASE=`grep Release ceph.spec | sed 's/Release:[ \t]*//g' | cut -d '%' -f 1`
RPM_VERSION=`grep Version ceph.spec | sed 's/Version:[ \t]*//g'`
PACKAGE_MANAGER_VERSION="$RPM_VERSION-$RPM_RELEASE"

BUILDAREA=$(setup_rpm_build_area ./rpm/$dist)
build_rpms $BUILDAREA "${CEPH_EXTRA_RPMBUILD_ARGS}"

# Make sure we execute at the top level directory
cd "$WORKSPACE"

[ "$FORCE" = true ] && chacra_flags="--force" || chacra_flags=""

if [ "$THROWAWAY" = false ] ; then
    # push binaries to chacra
    find release/${vers}/rpm/*/SRPMS | grep rpm | $VENV/chacractl binary ${chacra_flags} create ${chacra_endpoint}/source
    find release/${vers}/rpm/*/RPMS/* | grep rpm | $VENV/chacractl binary ${chacra_flags} create ${chacra_endpoint}/${ARCH}
    # extract cephadm if it exists
    if [ -f ${BUILDAREA}/RPMS/noarch/cephadm-*.rpm ] ; then
        rpm2cpio ${BUILDAREA}/RPMS/noarch/cephadm-*.rpm  | cpio -i --to-stdout *sbin/cephadm > cephadm
        echo cephadm | $VENV/chacractl binary ${chacra_flags} create ${chacra_endpoint}/${ARCH}/flavors/${FLAVOR}
    fi
    # write json file with build info
    cat > $WORKSPACE/repo-extra.json << EOF
{
    "version":"$vers",
    "package_manager_version":"$PACKAGE_MANAGER_VERSION",
    "build_url":"$BUILD_URL",
    "root_build_cause":"$ROOT_BUILD_CAUSE",
    "node_name":"$NODE_NAME",
    "job_name":"$JOB_NAME"
}
EOF
    chacra_repo_endpoint="${chacra_endpoint}/flavors/${FLAVOR}"
    # post the json to repo-extra json to chacra
    curl -X POST -H "Content-Type:application/json" --data "@$WORKSPACE/repo-extra.json" -u $CHACRACTL_USER:$CHACRACTL_KEY https://chacra.ceph.com/repos/${chacra_repo_endpoint}/extra/
    # start repo creation
    $VENV/chacractl repo update ${chacra_repo_endpoint}
fi

# XXX perhaps use job parameters instead of literals; then
# later stages can also use them to compare etc.
if [[ $DISTRO == "centos" && "$RELEASE" =~ 8|9 ]] ; then
    loop=0
    ready=false
    while ((loop < 15)); do
      curl -s "https://shaman.ceph.com/api/search/?project=ceph&distros=centos/${RELEASE}/${ARCH}&sha1=${SHA1}&ref=${BRANCH}&flavor=${FLAVOR}" > shaman.status
      if [[ ($(jq -r '.[0].extra.build_url' < shaman.status) == ${BUILD_URL}) && ($(jq -r '.[0].status' < shaman.status) == 'ready') ]] ; then ready=true; break; fi
      ((loop = loop + 1))
      sleep 60
    done

    if [[ "$ready" == "false" ]] ; then
      echo "FAIL: timed out waiting for shaman repo to be built:  https://shaman.ceph.com/api/repos/${chacra_endpoint}/flavors/${FLAVOR}/"
      # don't fail the build here on purpose
      # update_build_status "failed" "ceph" $NORMAL_DISTRO $NORMAL_DISTRO_VERSION $NORMAL_ARCH
      # exit 1
    fi
    # get into $WORKSPACE/$dist/ceph-$cephver, where the copied source tree is
    cd ${WORKSPACE}/dist/ceph-${cephver}/container
    CEPH_SHA1=${SHA1} ./build.sh
fi
