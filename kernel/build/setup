#!/bin/bash
#
# Ceph distributed storage system
#
# Copyright (C) 2016 Red Hat <contact@redhat.com>
#
# Author: Boris Ranto <branto@redhat.com>
#
#  This library is free software; you can redistribute it and/or
#  modify it under the terms of the GNU Lesser General Public
#  License as published by the Free Software Foundation; either
#  version 2.1 of the License, or (at your option) any later version.
#
set -ex
HOST=$(hostname --short)
echo "Building on $(hostname)"
echo "  DIST=${DIST}"
echo "  BPTAG=${BPTAG}"
echo "  KEYID=${KEYID}"
echo "  WS=$WORKSPACE"
echo "  PWD=$(pwd)"
echo "  BUILD SOURCE=$COPYARTIFACT_BUILD_NUMBER_CEPH_SETUP"
echo "*****"
env
echo "*****"

# ---- Pin target distro from Jenkins env (not host) ----
pick_first() { printf "%s\n" "$1" | tr ' ,;' '\n' | sed -n '1p'; }

TARGET_DIST_RAW="${DIST:-}"
if [[ -z "$TARGET_DIST_RAW" && -n "${DISTROS:-}" ]]; then
  TARGET_DIST_RAW="$(pick_first "$DISTROS")"
fi
if [[ -z "$TARGET_DIST_RAW" ]]; then
  echo "ERROR: Neither DIST nor DISTROS set; cannot determine target distro." >&2
  exit 1
fi

case "$TARGET_DIST_RAW" in
  rocky10)
    export DIST="rocky10"
    export DISTRO="rocky"
    export RELEASE="10"
    export NORMAL_DISTRO="rocky"
    export NORMAL_DISTRO_VERSION="10"
    export BUILD_IN_CONTAINER=1      # hint for later script
    ;;
  el9|centos9|c9s|centos-stream9)
    export DIST="el9"
    export DISTRO="centos"
    export RELEASE="9"
    export NORMAL_DISTRO="centos"
    export NORMAL_DISTRO_VERSION="9"
    export BUILD_IN_CONTAINER=        # host build OK
    ;;
  *)
    # Fallback: if you have more targets, add them here. Last resort: host detect.
    echo "WARN: Unrecognized target '$TARGET_DIST_RAW' â€” falling back to host detection for NORMAL_DISTRO only."
    # We still avoid mutating DIST/DISTRO/RELEASE unless you want to.
    ;;
esac

echo "Pinned target: DIST=${DIST} DISTRO=${DISTRO} RELEASE=${RELEASE}"
echo "Shaman will report NORMAL_DISTRO=${NORMAL_DISTRO} NORMAL_DISTRO_VERSION=${NORMAL_DISTRO_VERSION}"

if test $(id -u) != 0 ; then
    SUDO=sudo
fi
export LC_ALL=C # the following is vulnerable to i18n

if test -f /etc/redhat-release ; then
    $SUDO yum install -y bc
    $SUDO yum install -y elfutils-libelf-devel  # for ORC unwinder
    $SUDO yum install -y flex bison  # for Kconfig
    $SUDO yum install -y dwarves
    $SUDO yum install -y elfutils-devel  # for dwarf.h
fi

if which apt-get > /dev/null ; then
    $SUDO apt-get install -y bc
    $SUDO apt-get install -y lsb-release
    $SUDO apt-get install -y libelf-dev  # for ORC unwinder
    $SUDO apt-get install -y flex bison  # for Kconfig
    $SUDO apt-get install -y dwarves
    $SUDO apt-get install -y libdw-dev  # for dwarf.h
fi

case $DISTRO in
rhel|centos|fedora|sles|opensuse-leap)
        case $DISTRO in
            opensuse)
                $SUDO zypper -y yum-utils
                ;;
            *)
                $SUDO yum install -y yum-utils mock
                ;;
        esac
        ;;
*)
        echo "$DISTRO is unknown, dependencies will have to be installed manually."
        ;;
esac

pkgs=( "chacractl>=0.0.21" )
TEMPVENV=$(create_venv_dir)
VENV=${TEMPVENV}/bin
install_python_packages $TEMPVENV "pkgs[@]"

# ask shaman which chacra instance to use
chacra_url=`curl -u $SHAMAN_API_USER:$SHAMAN_API_KEY https://shaman.ceph.com/api/nodes/next/`
make_chacractl_config $chacra_url

BRANCH=$(branch_slash_filter $BRANCH)

# Make sure we execute at the top level directory
cd "$WORKSPACE"

# Clean the git repo
git clean -fxd

# Export the SHA1 so links work here: https://shaman.ceph.com/builds/kernel/
# This gets sent to update_build_status which calls submit_build_status in build_utils.sh.
export SHA1="${GIT_COMMIT}"

# create build status in shaman
update_build_status "started" "kernel" $NORMAL_DISTRO $NORMAL_DISTRO_VERSION $ARCH
